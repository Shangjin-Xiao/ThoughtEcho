name: Flutter Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.7.2'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Verify the installation
      run: flutter doctor -v

    - name: Analyze project source
      run: flutter analyze

    - name: Check formatting
      run: dart format --set-exit-if-changed .

    - name: Run unit tests
      run: flutter test --coverage

    - name: Run unit tests with verbose output
      run: flutter test --reporter expanded

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        name: thoughtecho-coverage
        fail_ci_if_error: false

  integration-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.7.2'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Enable desktop support
      run: |
        flutter config --enable-linux-desktop
        flutter config --enable-windows-desktop

    - name: Run integration tests on Linux
      run: |
        export DISPLAY=:99
        sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
        flutter test integration_test/ -d linux

  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.7.2'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Build APK
      run: flutter build apk --debug

    - name: Build web app
      run: flutter build web

    - name: Enable desktop and build Linux
      run: |
        flutter config --enable-linux-desktop
        sudo apt-get update -y
        sudo apt-get install -y ninja-build libgtk-3-dev
        flutter build linux

  test-coverage:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.7.2'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Install lcov
      run: sudo apt-get install -y lcov

    - name: Run tests with coverage
      run: flutter test --coverage

    - name: Generate coverage report
      run: |
        lcov --summary coverage/lcov.info
        lcov --list coverage/lcov.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        name: thoughtecho-coverage
        flags: unittests
        fail_ci_if_error: false

    - name: Coverage Comment
      uses: 5monkeys/cobertura-action@master
      if: github.event_name == 'pull_request'
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        path: coverage/lcov.info
        minimum_coverage: 70
        show_missing: true
        show_line: true
        show_branch: true