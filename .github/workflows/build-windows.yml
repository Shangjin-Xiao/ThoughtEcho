name: Build Windows App

on:
  workflow_dispatch:
    inputs:
      app_version:
        description: 'åº”ç”¨ç‰ˆæœ¬å· (å¦‚: 1.2.0)'
        required: true
        default: '1.0.0'
        type: string
      flutter_version:
        description: 'Flutterç‰ˆæœ¬'
        required: false
        default: '3.35.3'
        type: choice
        options:
          - '3.35.3'
          - '3.29.2'
          - '3.27.0'
          - 'latest'
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: false
        default: 'release'
        type: choice
        options:
          - 'release'
          - 'profile'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ github.event.inputs.flutter_version || '3.29.2' }}
        channel: 'stable'
        cache: true
        
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
      
    - name: Update app version in pubspec.yaml
      run: |
        $version = "${{ github.event.inputs.app_version || '1.0.0' }}"
        $content = Get-Content pubspec.yaml -Raw
        $content = $content -replace 'version:\s*[\d\.]+\+?\d*', "version: $version+${{ github.run_number }}"
        $content | Set-Content pubspec.yaml -NoNewline
        Write-Output "Updated version to: $version+${{ github.run_number }}"
        
    - name: Flutter doctor
      run: flutter doctor -v
      
    - name: Get dependencies
      run: flutter pub get
      
    - name: Clean previous builds
      run: flutter clean
      
    - name: Update MSIX version
      run: |
        $version = "${{ github.event.inputs.app_version || '1.0.0' }}"
        $buildNumber = "${{ github.run_number }}"
        $msixVersion = "$version.0"  # MSIXéœ€è¦4ä½ç‰ˆæœ¬å·æ ¼å¼
        
        if (Test-Path "msix_config.yaml") {
          $content = Get-Content "msix_config.yaml" -Raw
          $content = $content -replace 'msix_version:\s*[\d\.]+', "msix_version: $msixVersion"
          $content | Set-Content "msix_config.yaml" -NoNewline
          Write-Output "Updated MSIX version to: $msixVersion"
        }
      
    - name: Build Windows app
      run: flutter build windows --${{ github.event.inputs.build_type || 'release' }} --verbose
      
    - name: Build MSIX installer
      shell: powershell
      continue-on-error: true  # å…è®¸MSIXæž„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡ŒåŽç»­æ­¥éª¤
      run: |
        Write-Host "æž„å»ºMSIXå®‰è£…åŒ…..." -ForegroundColor Yellow
        
        # è®¾ç½®éžäº¤äº’å¼çŽ¯å¢ƒå˜é‡
        $env:CI = "true"
        $env:MSIX_SILENT = "true"
        $env:FLUTTER_SUPPRESS_ANALYTICS = "true"
        
        try {
          # ç¡®ä¿MSIXé…ç½®æ–‡ä»¶å­˜åœ¨
          if (!(Test-Path "msix_config.yaml")) {
            Write-Warning "msix_config.yaml ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          }
          
          # æ£€æŸ¥Windowsæž„å»ºæ˜¯å¦æˆåŠŸ
          $buildType = "${{ github.event.inputs.build_type || 'release' }}"
          $buildPath = if ($buildType -eq "release") { "build/windows/x64/runner/Release" } else { "build/windows/x64/runner/Profile" }
          
          if (!(Test-Path "$buildPath/thoughtecho.exe")) {
            Write-Error "Windowsæž„å»ºæ–‡ä»¶ä¸å­˜åœ¨: $buildPath/thoughtecho.exe"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_success=false"
            exit 1
          }
          
          Write-Host "å¼€å§‹æž„å»ºMSIXåŒ…..." -ForegroundColor Green
          
          # ç›´æŽ¥è¿è¡ŒMSIXåˆ›å»ºå‘½ä»¤
          flutter pub run msix:create
          $exitCode = $LASTEXITCODE
          
          if ($exitCode -eq 0) {
            # æ£€æŸ¥MSIXæ–‡ä»¶æ˜¯å¦å®žé™…åˆ›å»ºæˆåŠŸ
            $msixPath = "build/windows/x64/runner/Release/ThoughtEcho-Setup.msix"
            if (Test-Path $msixPath) {
              $msixSize = (Get-Item $msixPath).Length
              Write-Host "âœ… MSIXæž„å»ºæˆåŠŸï¼æ–‡ä»¶å¤§å°: $([math]::Round($msixSize/1MB, 2)) MB" -ForegroundColor Green
              Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_success=true"
              Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_path=$msixPath"
            } else {
              Write-Warning "âš ï¸ MSIXå‘½ä»¤æ‰§è¡ŒæˆåŠŸä½†æ–‡ä»¶æœªæ‰¾åˆ°: $msixPath"
              Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_success=false"
            }
          } else {
            Write-Warning "âš ï¸ MSIXæž„å»ºå¤±è´¥ï¼ˆé€€å‡ºç : $exitCodeï¼‰"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_success=false"
          }
        }
        catch {
          Write-Warning "âš ï¸ MSIXæž„å»ºå¼‚å¸¸: $($_.Exception.Message)"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_success=false"
        }
      id: msix_build
      env:
        FLUTTER_SUPPRESS_ANALYTICS: true
      
    - name: Get app version
      id: version
      run: |
        $version = (Get-Content pubspec.yaml | Select-String 'version:').ToString().Split(':')[1].Trim()
        Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"
        Write-Output "App version: $version"
      
    - name: Create release packages
      run: |
        $buildType = "${{ github.event.inputs.build_type || 'release' }}"
        $buildPath = if ($buildType -eq "release") { "build/windows/x64/runner/Release" } else { "build/windows/x64/runner/Profile" }
        $version = "${{ steps.version.outputs.version }}"
        
        if (!(Test-Path $buildPath)) {
            Write-Error "æž„å»ºè·¯å¾„ä¸å­˜åœ¨: $buildPath"
            exit 1
        }
        
        # åˆ›å»ºZIPåŽ‹ç¼©åŒ…
        $archiveName = "thoughtecho-windows-x64-v$version-$buildType.zip"
        New-Item -ItemType Directory -Path "release_temp" -Force
        Copy-Item -Path "$buildPath/*" -Destination "release_temp/" -Recurse
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å†…å®¹
        $versionInfo = "ThoughtEcho Windowsç‰ˆæœ¬ä¿¡æ¯`nç‰ˆæœ¬: $version`næž„å»ºç±»åž‹: $buildType`næž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`nFlutterç‰ˆæœ¬: ${{ github.event.inputs.flutter_version || '3.29.2' }}`næäº¤: ${{ github.sha }}`n`nä½¿ç”¨è¯´æ˜Ž:`n1. è§£åŽ‹åˆ°ä»»æ„æ–‡ä»¶å¤¹`n2. åŒå‡» thoughtecho.exe å¯åŠ¨åº”ç”¨`n3. å¦‚é‡é—®é¢˜è¯·æŸ¥çœ‹ logs æ–‡ä»¶å¤¹ä¸‹çš„æ—¥å¿—æ–‡ä»¶`n`næ³¨æ„äº‹é¡¹:`n- é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ç­‰å¾…æ•°ç§’`n- ç¡®ä¿ç³»ç»Ÿå·²å®‰è£…Visual C++ Redistributable`n- å»ºè®®åœ¨è§£åŽ‹åŽå°†æ•´ä¸ªæ–‡ä»¶å¤¹æ·»åŠ åˆ°æ€æ¯’è½¯ä»¶ç™½åå•"
        $versionInfo | Out-File -FilePath "release_temp/VERSION_INFO.txt" -Encoding UTF8
        $versionInfo | Out-File -FilePath "release_temp/ç‰ˆæœ¬ä¿¡æ¯.txt" -Encoding UTF8

        # åˆ›å»ºå¯åŠ¨è„šæœ¬å†…å®¹
        $launchScript = "@echo off`necho æ­£åœ¨å¯åŠ¨ ThoughtEcho...`necho é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ç­‰å¾…æ•°ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…`necho.`nstart thoughtecho.exe`necho å¦‚æžœåº”ç”¨æœªæ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯.txtä¸­çš„æ³¨æ„äº‹é¡¹`npause"
        $launchScript | Out-File -FilePath "release_temp/LAUNCH_APP.bat" -Encoding Default
        $launchScript | Out-File -FilePath "release_temp/å¯åŠ¨åº”ç”¨.bat" -Encoding Default
        
        Compress-Archive -Path "release_temp/*" -DestinationPath $archiveName -Force
        
        # æ£€æŸ¥MSIXæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        $msixSuccess = "${{ steps.msix_build.outputs.msix_success }}" -eq "true"
        $msixPath = "${{ steps.msix_build.outputs.msix_path }}"
        
        if ($msixSuccess -and $msixPath -and (Test-Path $msixPath)) {
            $msixName = "thoughtecho-windows-x64-v$version-$buildType.msix"
            Copy-Item -Path $msixPath -Destination $msixName
            Add-Content -Path $env:GITHUB_OUTPUT -Value "msix_name=$msixName"
            Write-Output "âœ… åˆ›å»ºMSIXå®‰è£…åŒ…: $msixName"
        } else {
            if (!$msixSuccess) {
                Write-Output "âš ï¸ MSIXæž„å»ºå¤±è´¥ï¼Œè·³è¿‡MSIXæ‰“åŒ…"
            } elseif (!$msixPath) {
                Write-Output "âš ï¸ MSIXæ–‡ä»¶è·¯å¾„æœªè®¾ç½®ï¼Œè·³è¿‡MSIXæ‰“åŒ…"
            } else {
                Write-Output "âš ï¸ MSIXæ–‡ä»¶æœªæ‰¾åˆ°: $msixPathï¼Œè·³è¿‡MSIXæ‰“åŒ…"
            }
            Write-Output "ä¸»è¦çš„Windowsåº”ç”¨å·²ç»æž„å»ºæˆåŠŸï¼Œå¯ä»¥é€šè¿‡ZIPåŒ…åˆ†å‘"
        }
        
        Add-Content -Path $env:GITHUB_OUTPUT -Value "archive_name=$archiveName"
        Write-Output "åˆ›å»ºZIPå‘å¸ƒåŒ…: $archiveName"
      id: archive
      
    - name: Upload ZIP build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: thoughtecho-windows-${{ github.event.inputs.build_type || 'release' }}-zip
        path: ${{ steps.archive.outputs.archive_name }}
        retention-days: 90
        
    - name: Upload MSIX installer
      if: steps.archive.outputs.msix_name != ''
      uses: actions/upload-artifact@v4
      with:
        name: thoughtecho-windows-${{ github.event.inputs.build_type || 'release' }}-msix
        path: ${{ steps.archive.outputs.msix_name }}
        retention-days: 90
        
    - name: Build summary
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $buildType = "${{ github.event.inputs.build_type || 'release' }}"
        $archiveName = "${{ steps.archive.outputs.archive_name }}"
        $msixName = "${{ steps.archive.outputs.msix_name }}"
        $msixSuccess = "${{ steps.msix_build.outputs.msix_success }}" -eq "true"
        
        Write-Output "## ðŸŽ‰ Windowsæž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "### ðŸ“‹ æž„å»ºä¿¡æ¯" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **åº”ç”¨ç‰ˆæœ¬**: $version" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **æž„å»ºç±»åž‹**: $buildType" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **Flutterç‰ˆæœ¬**: ${{ github.event.inputs.flutter_version || '3.29.2' }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **æäº¤å“ˆå¸Œ**: ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "### ðŸ“¦ å‘å¸ƒæ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **ZIPåŽ‹ç¼©åŒ…**: âœ… $archiveName" >> $env:GITHUB_STEP_SUMMARY
        
        if ($msixSuccess -and $msixName) {
            Write-Output "- **MSIXå®‰è£…åŒ…**: âœ… $msixName" >> $env:GITHUB_STEP_SUMMARY
        } else {
            Write-Output "- **MSIXå®‰è£…åŒ…**: âŒ æž„å»ºå¤±è´¥ï¼ˆå¯ä½¿ç”¨ZIPåŒ…æ›¿ä»£ï¼‰" >> $env:GITHUB_STEP_SUMMARY
        }
        
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "1. åœ¨Actionsé¡µé¢çš„Artifactséƒ¨åˆ†ä¸‹è½½å¯¹åº”çš„å‘å¸ƒåŒ…" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "2. **ZIPåŒ…**: è§£åŽ‹åŽç›´æŽ¥è¿è¡Œ thoughtecho.exe" >> $env:GITHUB_STEP_SUMMARY
        
        if ($msixSuccess) {
            Write-Output "3. **MSIXåŒ…**: åŒå‡»å®‰è£…åˆ°ç³»ç»Ÿï¼ˆæŽ¨èï¼‰" >> $env:GITHUB_STEP_SUMMARY
        } else {
            Write-Output "3. **MSIXåŒ…**: æœ¬æ¬¡æž„å»ºå¤±è´¥ï¼Œè¯·ä½¿ç”¨ZIPåŒ…" >> $env:GITHUB_STEP_SUMMARY
        }
        
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "### âš ï¸ æ³¨æ„äº‹é¡¹" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ç­‰å¾…æ•°ç§’" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- ç¡®ä¿ç³»ç»Ÿå·²å®‰è£… Visual C++ Redistributable" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- å»ºè®®å°†åº”ç”¨æ–‡ä»¶å¤¹æ·»åŠ åˆ°æ€æ¯’è½¯ä»¶ç™½åå•" >> $env:GITHUB_STEP_SUMMARY
